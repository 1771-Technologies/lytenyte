<script is:inline>
  let controller;
  function handleToggle(controller) {
    const btns = Array.from(document.querySelectorAll(".xd-collapse-btn"));

    btns.forEach((btn) => {
      const root = btn.parentElement?.parentElement;
      if (!root) return;

      const id = root.getAttribute("data-group-id");
      btn.addEventListener(
        "click",
        () => {
          const expanded = root.getAttribute("data-collapsed") === "true";
          if (expanded) root.setAttribute("data-collapsed", "false");
          else root.setAttribute("data-collapsed", "true");

          if (id) localStorage.setItem(`nav_group:${id}`, expanded ? "false" : "true");
        },
        { signal: controller.signal },
      );

      const state = localStorage.getItem(`nav_group:${id}`);
      if (!state) return;
      root.setAttribute("data-collapsed", state);
    });
  }

  function handleSidebarScroll() {
    const sidebar = document.getElementById("ln-sidebar");
    sidebar.style.opacity = 1;

    const scroll = Number.parseInt(localStorage.getItem("sidebar-scroll"));
    const href = localStorage.getItem("sidebar-href");
    if (!Number.isNaN(scroll)) {
      sidebar.scrollTo({ top: scroll, behavior: "instant" });
      localStorage.removeItem("sidebar-scroll");
      localStorage.removeItem("sidebar-href");
    }

    const links = Array.from(sidebar.querySelectorAll("a"));
    links.forEach((x) => {
      if (x.href === href) x.focus();

      x.addEventListener("click", () => {
        const scrollTop = sidebar.scrollTop;
        localStorage.setItem("sidebar-scroll", scrollTop);
        localStorage.setItem("sidebar-href", x.href);
      });
      x.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const scrollTop = sidebar.scrollTop;
          localStorage.setItem("sidebar-scroll", scrollTop);
          localStorage.setItem("sidebar-href", x.href);
        }
      });
    });

    setTimeout(() => {
      sidebar.classList.remove("no-transition");
    }, 80);
  }

  window.addEventListener("load", () => {
    if (controller) controller.abort();
    controller = new AbortController();
    handleToggle(controller);

    handleSidebarScroll();
  });

  document.addEventListener("astro:after-swap", () => {
    if (controller) controller.abort();
    controller = new AbortController();
    handleToggle(controller);

    handleSidebarScroll();
  });
</script>
