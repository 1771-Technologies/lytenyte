<script is:inline>
  const theme = { value: "" };
  const storageKey = "theme-preference";
  const toggleTheme = () => {
    theme.value = theme.value === "light" ? "dark" : "light";
    setStoredThemePreference();
  };

  const getStoredPreferenceOrFallback = () => {
    const storedPreference = localStorage.getItem(storageKey);
    if (storedPreference) return storedPreference;

    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  };

  const setStoredThemePreference = () => {
    localStorage.setItem(storageKey, theme.value);
    reflectPreference();
  };

  const reflectPreference = (noTransition = false) => {
    if (noTransition) document.documentElement.classList.add("no-transition");
    document.documentElement.setAttribute("data-theme", theme.value);
    document.documentElement.classList.remove(theme.value === "dark" ? "light" : "dark");
    document.documentElement.classList.add(theme.value);
    document.documentElement.classList.remove(theme.value === "dark" ? "ln-light" : "ln-dark");
    document.documentElement.classList.add(theme.value === "dark" ? "ln-dark" : "ln-light");

    document.querySelector("#theme-toggle")?.setAttribute("aria-label", theme.value);
    if (noTransition)
      setTimeout(() => {
        document.documentElement.classList.remove("no-transition");
      });
  };

  theme.value = getStoredPreferenceOrFallback();

  reflectPreference(true);

  window.addEventListener("load", () => {
    reflectPreference();
    document.querySelector("#theme-toggle")?.addEventListener("click", toggleTheme);
  });

  document.addEventListener("astro:after-swap", () => {
    reflectPreference(true);
    document.querySelector("#theme-toggle")?.addEventListener("click", toggleTheme);
  });

  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches: isDark }) => {
    theme.value = isDark ? "dark" : "light";
    setStoredThemePreference();
  });
</script>
